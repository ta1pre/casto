# テスト実行ガイド

## 概要
認証・認可システムのテストスイートは、以下のテストで構成されています：

- **単体テスト**: 各コンポーネントの個別機能テスト
- **統合テスト**: システム全体の連携テスト
- **パフォーマンステスト**: 負荷耐性とパフォーマンス測定

## テストの実行

### 1. バックエンドテスト（Cloudflare Workers）

```bash
# プロジェクトルートで実行
# すべてのテスト実行
npm test

# 特定のテストファイル実行
npm test -- src/__tests__/auth.test.ts

# カバレッジレポート生成
npm run test:coverage

# ウォッチモードでテスト実行
{{ ... }}
cd apps/web

# すべてのテスト実行
npm test

# カバレッジレポート生成
- ✅ セッションの作成・取得・更新・削除
- ✅ セッションの有効期限管理
- ✅ セッションの延長
- ✅ クリーンアップ処理

#### useAuth（Reactフック）
- ✅ 初期状態管理
- ✅ ログイン・ログアウト処理
- ✅ セッション更新
- ✅ 権限・ロールチェック
- ✅ エラーハンドリング

### 統合テスト

#### 認証フロー
- ✅ ログイン → セッション取得 → ログアウトの流れ
- ✅ セッション情報の取得・更新
- ✅ エラーハンドリング

#### 認可フロー
- ✅ 保護されたルートのアクセス制御
- ✅ 管理者権限のチェック
- ✅ 権限不足時の適切なエラー応答

#### RBAC統合
- ✅ ロール管理機能
- ✅ 権限チェック機能
- ✅ ユーザー権限・ロールの取得

### パフォーマンステスト

#### 認証パフォーマンス
- ✅ 認証ミドルウェアの処理速度（10ms以内）
- ✅ 同時リクエスト処理（100ms以内）
- ✅ キャッシュ効果の検証（5ms以内）

#### RBACパフォーマンス
- ✅ 権限チェックの速度（1ms以内）
- ✅ ロール階層チェックの効率性（5ms以内）

#### メモリ使用量
- ✅ メモリリークの防止（100MB以内）
- ✅ 同時セッション処理時のメモリ管理

#### 負荷テスト
- ✅ 高負荷時の安定性（1秒以内）
- ✅ 認証状態の混在処理

## テスト結果の基準

### パフォーマンス基準
- **認証ミドルウェア**: 10ms以内
- **権限チェック**: 1ms以内
- **同時リクエスト**: 100ms以内
- **メモリ増加**: 100MB以内

### 信頼性基準
- **テスト成功率**: 95%以上
- **カバレッジ**: 80%以上
- **エラーハンドリング**: 100%カバー

## トラブルシューティング

### テストが失敗する場合

1. **型エラー**
   ```bash
   # TypeScriptの型チェック
   npm run type-check
   ```

2. **依存関係の確認**
   ```bash
   npm install
   ```

3. **モック設定の確認**
   - KVNamespaceのモックが適切に設定されているか
   - 外部APIのモックが適切か

### パフォーマンステストが遅い場合

1. **マシンスペック確認**
   - CPU: 2コア以上推奨
   - メモリ: 4GB以上推奨

2. **テスト環境の最適化**
   ```bash
   # Node.jsのメモリ制限を増やす
   NODE_OPTIONS="--max-old-space-size=4096" npm test
   ```

## 継続的インテグレーション

### GitHub Actionsでの自動テスト
```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm ci
      - run: npm test
      - run: npm run test:coverage
```

## レポート

### カバレッジレポート
```bash
# バックエンド
npm run test:coverage

# フロントエンド
cd apps/web && npm run test:coverage
```

### パフォーマンスレポート
- 自動生成されるHTMLレポートを確認
- ボトルネック箇所の特定
- 最適化の提案

## メンテナンス

### テストの追加
1. 新機能追加時は対応するテストを追加
2. バグ修正時は回帰テストを追加
3. パフォーマンス改善時はベンチマークテストを追加

### テストの更新
1. API変更時は関連テストを更新
2. 環境変更時はモック設定を更新
3. 依存関係変更時はインテグレーションテストを更新
