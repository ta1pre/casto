# 認証・認可システムの設計と実装（ヘッダー表示含む）

## 1. 目的
- **認証**: ユーザーの識別と検証を行い、システムへのアクセスを制御します。[SFT][ISA]
- **認可**: ユーザーの権限に基づき、リソースへのアクセスを制御します。[SFT][RP]
- **セッション管理**: 認証状態を維持し、情報の経路を管理します。[SF][PA]
- **ヘッダー表示**: 認証・認可状態をUIで可視化し、ユーザビリティを向上します。[RP][DM]

## 2. システムアーキテクチャ

### 2.1 レイヤー構造
```
┌─────────────────────────────────────────────────────────────┐
│                    アプリケーション層                       │
├─────────────────────────────────────────────────────────────┤
│  プレゼンテーション層（Web UI）                              │
│  - Header.tsx: 認証状態の表示                               │
│  - RoleSwitch: ロール切り替え                              │
│  - 各種コンポーネント: 権限に基づく表示制御                 │
├─────────────────────────────────────────────────────────────┤
│              ビジネスロジック層                              │
│  - API Routes: 認証・認可付きのエンドポイント               │
│  - Domain Services: ビジネスルールの適用                   │
├─────────────────────────────────────────────────────────────┤
│              インフラストラクチャ層                         │
│  - Middleware: 認証・認可・セッション管理                   │
│  - Database: ユーザー・権限データの永続化                   │
│  - External Services: LINE, Supabase Auth                   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 ミドルウェア設計

#### 統合ミドルウェアアーキテクチャ
```
┌─────────────────────────────────────────────────────────────┐
│                    認証・認可・セッション管理                    │
├─────────────────────────────────────────────────────────────┤
│  認証ミドルウェア: JWT検証・セッション取得・エラー処理           │
│  認可ミドルウェア: 権限確認・リソースアクセス制御               │
│  セッションミドルウェア: 状態管理・キャッシュ・有効期限管理     │
└─────────────────────────────────────────────────────────────┘
```

#### 処理フロー
**認証フロー**:
```
┌─────────┐    ┌─────────────┐    ┌────────────┐    ┌─────────┐
│ Request │───▶│ JWT検証     │───▶│ セッション │───▶│ Context │
│         │    │             │    │ 取得       │    │ 設定    │
└─────────┘    └─────────────┘    └────────────┘    └─────────┘
```

**認可フロー**:
```
┌─────────┐    ┌─────────────┐    ┌────────────┐    ┌─────────┐
│ Context │───▶│ 権限確認    │───▶│ リソース   │───▶│ アクセス│
│         │    │             │    │ アクセス可否│    │ 許可/拒否│
└─────────┘    └─────────────┘    └────────────┘    └─────────┘
```

**セッションフロー**:
```
┌─────────┐    ┌─────────────┐    ┌────────────┐    ┌─────────┐
│  Client │───▶│ Session MW  │───▶│ Cache      │───▶│ Database│
│         │    │ (状態管理)  │    │ (高速取得) │    │ (永続化)│
└─────────┘    └─────────────┘    └────────────┘    └─────────┘
```

#### 各ミドルウェアの役割
- **認証ミドルウェア**: すべてのリクエストで認証状態を検証し、セッション情報を取得
- **認可ミドルウェア**: ユーザーの権限に基づき、リソースへのアクセスを制御
- **セッションミドルウェア**: 認証状態を維持し、キャッシュと有効期限を管理

## 3. 詳細設計

### 3.1 権限システム設計

#### ロールベースアクセス制御（RBAC）
```
┌─────────────────────────────────────────────────────────────┐
│  ロール定義                                                 │
├─────────────────────────────────────────────────────────────┤
│  admin: システム全体の管理者権限                             │
│  host: ホスト（主催者）権限                                  │
│  manager: マネージャー権限                                  │
│  fan: ファン（一般ユーザー）権限                            │
│  guest: ゲスト（未認証）権限                                │
└─────────────────────────────────────────────────────────────┘
```

#### 権限マトリックス
| リソース | admin | host | manager | fan | guest |
|----------|-------|------|---------|-----|-------|
| ユーザー管理 | ✓ | ✗ | ✗ | ✗ | ✗ |
| イベント管理 | ✓ | ✓ | ✓ | ✗ | ✗ |
| コンテンツ閲覧 | ✓ | ✓ | ✓ | ✓ | ✓ |
| プロフィール編集 | ✓ | ✓ | ✓ | ✓ | ✗ |

### 3.2 セッション管理設計

#### セッションデータ構造
```typescript
interface Session {
  userId: string;
  roles: Role[];
  permissions: Permission[];
  displayName: string;
  provider: 'line' | 'email';
  expiresAt: Date;
  lastActivity: Date;
}
```

#### セッションライフサイクル
1. **認証時**: セッション作成・JWT発行
2. **リクエスト時**: セッション検証・更新
3. **タイムアウト**: セッション無効化
4. **ログアウト**: セッション明示的削除

### 3.3 パフォーマンス最適化設計

#### 効率化戦略
- **クライアントサイドキャッシュ**: SWRを使用した5分間キャッシュ
- **条件付き認証**: 公開ページは認証チェックをスキップ
- **Middleware制御**: Next.js Middlewareでページレベル認証制御
- **セッションキャッシュ**: KVストアを使った高速セッション取得

#### 最適化された処理フロー
```
┌─────────┐    ┌─────────────┐    ┌────────────┐    ┌─────────┐
│  Client │───▶│ Middleware  │───▶│ キャッシュ │───▶│ 認証    │
│         │    │ (条件付き)  │    │ チェック   │    │ 処理    │
└─────────┘    └─────────────┘    └────────────┘    └─────────┘
```

#### ページ遷移時の最適化
- **公開ページ**: 認証チェックなし（高速）
- **保護ページ**: キャッシュヒット時は即時表示
- **初回アクセス**: 最小限のCloudflare Workers呼び出し

## 4. 実装タスク

### 0. システム基盤整備
- [x] **0-1. Identity DB スキーマ整備**
  - [x] `users`, `user_handles`, `roles`, `user_roles`, `permissions`, `role_permissions` のカラム・制約を整理
  - [x] ヘッダー表示に必要な属性（例: `display_name`, ロール名）を決定
- [x] **0-2. マイグレーション計画の起草**
  - [x] `supabase/migrations/` のファイル構成と適用順序を草案化
  - [x] 合意形成のためのレビュー資料を `docs/reviews/` に整理（例: `docs/reviews/identity_db_migration_20250924.md`）
  - **メモ**: 2025-09-24 Supabase 本番DB (`sfscmpjplvxtikmifqhe`) を `supabase db reset --linked` で初期化し、`001_initial_schema.sql` および Identity 系マイグレーションを適用完了。詳細は `docs/reviews/identity_db_migration_20250924.md` を参照。

### 1. 基本認証システム実装
- [ ] **1-1. 認証プロバイダー統合**
  - [ ] LINE LIFF認証とメール認証の共通インターフェース作成
  - [ ] 認証フローの統一（認証 → セッション作成 → JWT発行）
  - [ ] 認証エラーの統一的な処理
- [ ] **1-2. セッション管理基盤**
  - [ ] 統合ミドルウェアの実装（認証・認可・セッション）
  - [ ] セッションストアの実装（KVストア連携）
  - [ ] 基本的な権限チェック機能

### 2. 認可システム実装
- [ ] **2-1. RBACシステム構築**
  - [ ] ロール・権限データベース設計の実装
  - [ ] 権限チェックミドルウェアの強化
  - [ ] ユーザー・ロール・権限の関連付け
- [ ] **2-2. APIエンドポイント整備**
  - [ ] 認証・認可付きAPIエンドポイントの実装
  - [ ] エラーレスポンスの統一
  - [ ] APIドキュメントの更新

### 3. パフォーマンス最適化と統合
- [ ] **3-1. フロントエンド最適化**
  - [ ] クライアントサイドキャッシュ（SWR）の実装
  - [ ] セッション管理フックの更新
  - [ ] ヘッダーコンポーネントの権限対応
- [ ] **3-2. バックエンド最適化**
  - [ ] Next.js Middlewareでの条件付き認証
  - [ ] セッションキャッシュの効率化
  - [ ] パフォーマンス監視の設定
- [ ] **3-3. 全体統合テスト**
  - [ ] エンドツーエンドテスト
  - [ ] パフォーマンステスト
  - [ ] セキュリティテスト
