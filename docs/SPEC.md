# casto: 仕様書

## 1. 概要
- 目的/PURPOSE: `PURPOSE.md` を参照
- 対象ユーザー/利用シーン：
  このアプリは、「人を集めて選ぶ（オーディション）」を、スマホだけで簡単にできるサービスです。
  - **主催者**: 募集ページを作る → 応募を受付 → 連絡・審査 → 当日の運営（受付QR）まで実施
  - **応募者**: LINEでサクッと参加。プロフィール登録、動画・写真を提出、結果を受け取る
  - **ファン**: 投票や視聴（将来の配信・チケット・物販）で応援できる
  - **マネージャ/保護者**: 応募者の代理で提出・連絡ができる（委任）

  将来的には同じアカウントで、
  - クラファン（企画の資金集め）
  - 電子チケット・配信・物販（公演や発表会）
  までワンストップでつながります。

  かんたんに言うと：「集める→選ぶ→見せる→売る」を1つのIDで全部できるアプリ。

## 2. 用語定義
- **共通ID (User)**: 1人＝1つのユニークなID。全てのロールやアクティビティはこのIDに紐づく。
- **ロール (Role)**: ユーザーに付与される役割。複数付与可能。
  - **Applicant**: 応募者
  - **Organizer**: 主催者
  - **Fan**: ファン（投票・購入者）
  - **Manager**: 応募者のマネージャ/保護者
  - **(将来追加) CF_Creator**: クラウドファンディング起案者
  - **(将来追加) CF_Backer**: クラウドファンディング支援者
  - **(将来追加) Venue**: 会場提供者
  - **(将来追加) Sponsor**: スポンサー
  - **(将来追加) Staff**: イベント当日の運営スタッフ
- **アンカー**: 仮アカウントを本アカウントに確定させるための信頼性の担保。LINE連携またはeKYC完了が該当。
- **信頼レベル (Trust Level)**: 機能解放のトリガーとなるアカウントの信頼度。L0からL3まで存在する。

## 3. 機能要件（User Stories）

### 5-1. 応募者 → 主催者へ“昇格”
- ユーザーは**応募者**として、**主催者向けの機能を使いたい**ので、**シームレスに主催者ロールを追加できる**。
  - **AC1**: LINEでログイン中に「主催をはじめる」ボタンを押せる。
  - **AC2**: Emailを追加し、Magic Linkで認証できる。
  - **AC3**: 主催タイプ（個人/法人）を選択できる。
  - **AC4**: 信頼レベル（L1→L2→L3）を解放するためのチェックリストが表示される。
  - **AC5**: 通知はLINEに届き続け、契約や請求に関する通知はEmailに届く。

### 5-2. いきなり主催者で入りたい（メールから新規）
- ユーザーは**主催者**として、**すぐにオーディションを開始したい**ので、**メールアドレスで登録を開始できる**。
  - **AC1**: 「主催として登録」からEmail認証で仮アカウントが作成される。
  - **AC2**: LINE連携またはeKYCの完了（アンカー）を促され、本アカウントが発行される。
  - **AC3**: 信頼レベル（L1→L2）を解放するためのチェックリストが表示される。

### 5-3. マネージャ/保護者の委任
- ユーザーは**応募者**として、**マネージャや保護者に手続きを代行してほしい**ので、**特定のユーザーをマネージャとして招待できる**。
  - **AC1**: 応募者の画面から「マネージャを招待」機能をメールアドレスで利用できる。
  - **AC2**: 招待された側は自身の共通IDでログインし、委任を承認すると権限が付与される。
  - **AC3**: 委任関係は、応募者・マネージャの双方からいつでも解除できる。
  - **AC4**: 招待、承認、解除のアクションはすべて監査ログに記録される。

### 5-4. ファンの投票・購入
- ユーザーは**ファン**として、**不正なく公正に応援したい**ので、**安全な投票・購入ができる**。
  - **AC1**: 1ユーザー1票を基本とし、行動スコアで不正利用を検知する。
  - **AC2**: 重要な投票や高額な購入時には、追加の本人認証（Email OTP, 3Dセキュア等）が要求される。

### 6. 将来拡張

#### 6-1. クラウドファンディング
- ユーザーは**主催者**として、**プロジェクトの資金を調達したい**ので、**クラウドファンディングを起案できる**。
  - **AC1**: `CF_Creator` / `CF_Backer` ロールが共通IDに付与される。
  - **AC2**: 信頼レベルL2（eKYC＋受取口座）の主催者が起案できる。
  - **AC3**: All-or-Nothing方式を標準とし、プロジェクト成功後に課金される。
  - **AC4**: 信頼レベルL3のユーザーは早期入金オプションを選択できる（手数料増など）。

#### 6-2. 興行OS（電子チケット・PPV・物販）
- ユーザーは**主催者**として、**イベントの収益を最大化したい**ので、**チケットやグッズを販売できる**。
  - **AC1**: 信頼レベルL2以上の主催者が販売機能を利用できる。
  - **AC2**: 電子チケット、PPV（ペイ・パー・ビュー）、事前受注物販を同じカートで購入できる。
  - **AC3**: イベント当日はQRコードによる受付（もぎり）が可能で、オフラインでも動作する。
  - **AC4**: 投げ銭やギフティング機能も提供する。

## 4. 画面/UX（あれば）
- **信頼レベルチェックリスト**:
  - ユーザーが次の機能（公開、決済など）を解放するために必要なタスクを一覧表示する。
  - 未完了の項目だけが赤くハイライトされ、ユーザーが何をすべきか直感的に理解できるUI。
- **アカウント統合ウィザード**:
  - 登録しようとしたEmailやLINEが既存のアカウントに紐づいている場合に起動する。
  - 「このアカウントと統合しますか？」とユーザーに問いかけ、両アカウントの所有権を証明させる（LINE再承認＋Email Magic Link）ことで、安全なマージ処理に誘導する。
  - ユーザーを拒絶するのではなく、自然な流れでアカウントの重複を解消する。

## 5. インターフェース
- **外部IF（認証）**:
  - **LINE**: 応募者・ファンの主要なログイン手段。通知にも利用。
  - **Email (Magic Link / Passkey)**: 主催者・マネージャの必須ログイン手段。契約・請求通知にも利用。
  - **Google / Apple (任意)**: ソーシャルログインの選択肢。
  - **電話番号 (任意)**: 2要素認証や緊急連絡先のオプション。

## 6. データ/モデル
### アカウント設計思想
- **単一共通ID**: 1人の物理的人物は、単一の共通ID（User）のみを保持する。ユーザーが新しい役割（ロール）を開始しても、新しいIDは発行されない。
- **ロールベースのアクセス制御**: 機能へのアクセスは、共通IDに紐づくロールによって制御される。
- **遅延的な本アカウント発行 (アンカーモデル)**:
  - Email等で登録が開始されても、信頼性の高いアンカー（LINE連携 or eKYC完了）が確立されるまでは「仮アカウント」として扱われる。
  - アンカーが確立された瞬間に、既存アカウントとの照合・統合が行われ、「本アカウント」が発行される。これにより、電話番号なしでのアカウント重複を構造的に防ぐ。
- **安全なアカウント統合**:
  - 複数のアカウントが同一人物によって作成されたことが検出された場合、統合ウィザードを通じて安全にマージされる。
  - マージ処理は監査ログに記録され、統合直後は高リスク操作（出金先変更など）が一時的にロックされる。

### 役割ごとの必須・任意ルール
- **応募者**: 必須＝LINE / 任意＝Email
- **ファン**: 推奨＝LINE / 任意＝Email
- **主催者**: 必須＝Email / 任意＝LINE
- **マネージャ**: 必須＝Email

### 信頼レベルと解放機能（L0→L3）
- **L0**: ドラフト作成まで（登録直後）
- **L1**: 公開OK（主催者: 特商法情報入力 / 応募者: 年齢同意など）
- **L2**: 決済・出金OK（eKYC＋受取口座登録）
- **L3**: 高額・早期入金・法人向け（法人確認・反社チェックなど）

## 7. 非機能要件
- **セキュリティ**:
  - **二要素認証**: 出金先変更、アカウント統合などの高リスク操作には、Email OTPやPasskeyによる追加認証を要求する。
  - **監査ログ**: アカウント統合、権限委任/解除、出金先変更、本人確認の結果など、重要な操作はすべて記録する。
  - **冷却期間**: アカウント統合や本人確認情報の変更後、48時間は出金関連の操作をロックする。
- **ガバナンス**:
  - **未成年保護**: サービス利用時間、特定カテゴリ（酒類など）へのアクセスに年齢フラグを自動適用する。保護者同意のための電子署名付き同意書テンプレートを提供する。
  - **プライバシー**: 日常的な通知はLINEを中心に行い、契約書や領収書などの証跡が残るべき情報はEmailで送信する。

## 8. 設計方針
- アーキテクチャ概要（図/テキスト）
- 技術選定の理由（代替案/比較）

## 9. 受入基準（Definition of Done）
- テスト観点、品質条件、運用移管条件

## 10. 既知の制約/未決事項
- `QUESTIONS.md` を参照